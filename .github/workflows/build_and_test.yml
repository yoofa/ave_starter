name: 构建与测试

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'release/*'
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/yoofa/ave-build:latest
      options: --user builduser

    steps:
      # 创建 base-test-project 目录
      - name: 创建 base-test-project 目录
        run: mkdir -p /home/builduser/base-test-project
        
      - name: 创建 .gclient 文件
        run: |
          cat <<EOF > .gclient
          solutions = [
            { "name"        : 'src',
              "url"         : 'https://github.com/yoofa/base-test-project.git',
              "deps_file"   : 'DEPS',
              "managed"     : False,
              "custom_deps" : {
              },
              "custom_vars": {},
            },
          ]
          EOF
        working-directory: /home/builduser/base-test-project

      # 同步代码
      - name: 运行 gclient sync
        run: |
          gclient sync
        working-directory: /home/builduser/base-test-project

      # 编译项目
      - name: 使用 GN 和 Ninja 进行编译
        run: |
          cd src
          gn gen out/Default
          ninja -C out/Default
        working-directory: /home/builduser/base-test-project

      # 运行单元测试
      - name: 运行单元测试
        working-directory: /home/builduser/base-test-project
        run: |
          cd src/out/Default
          ./base_unittests
